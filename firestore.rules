rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isNonEmptyString(v) {
      return v is string && v.size() > 0 && v.size() <= 200;
    }

    function isValidEmail(v) {
      return v is string && v.size() > 3 && v.size() <= 320 && v.matches('^.+@.+\\..+$');
    }

    function isValidDepartment(v) {
      return v is string && v.size() > 0 && v.size() <= 100;
    }

    function isValidSalary(v) {
      // Only ensure it's a number. No min/max constraints per product decision.
      return (v is int || v is float);
    }

    function isValidISODate(v) {
      // Expecting YYYY-MM-DD string from the UI date input
      return v is string && v.matches('^\\d{4}-\\d{2}-\\d{2}$');
    }

    // ISO 8601 date-time such as 2025-09-26T12:34:56.789Z
    function isValidISODateTime(v) {
      return v is string && v.matches('^\\d{4}-\\d{2}-\\d{2}T[0-9:.-]+Z$');
    }

    function hasOnlyAllowedKeys(d) {
      // Allow only these keys (qid/phone/pdf urls are optional)
      return d.keys().hasOnly(['name','email','position','department','salary','joinDate','qid','phone','qidPdfUrl','passportPdfUrl']);
    }

    function validateEmployee(d) {
      return hasOnlyAllowedKeys(d)
        && isNonEmptyString(d.name)
        && isValidEmail(d.email)
        && isNonEmptyString(d.position)
        && isValidDepartment(d.department)
        && isValidSalary(d.salary)
        && isValidISODate(d.joinDate);
    }

    match /employees/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && validateEmployee(request.resource.data);
      allow update: if isSignedIn() && validateEmployee(request.resource.data);
      allow delete: if isSignedIn();
    }

    // Temporary employees collection with same schema/permissions
    match /temporaryEmployees/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && validateEmployee(request.resource.data);
      allow update: if isSignedIn() && validateEmployee(request.resource.data);
      allow delete: if isSignedIn();
    }

    // Customers collection used by the web app (no auth required for demo)
    function customersAllowedKeys(d) {
      return d.keys().hasOnly(['name','email','phone','company','createdAt']);
    }

    function validateCustomer(d) {
      return customersAllowedKeys(d)
        && isNonEmptyString(d.name)
        && isValidEmail(d.email)
        && (!('phone' in d) || (d.phone is string && d.phone.size() <= 30))
        && (!('company' in d) || (d.company is string && d.company.size() <= 200))
        && isValidISODateTime(d.createdAt);
    }

    match /customers/{docId} {
      // Open reads so the public site can list customers
      allow read: if true;
      // Allow creating/updating documents that pass validation
      allow create: if validateCustomer(request.resource.data);
      allow update: if validateCustomer(request.resource.data);
      // Disallow deletes for safety in this demo setup
      allow delete: if false;
    }

    // Everything else is denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
